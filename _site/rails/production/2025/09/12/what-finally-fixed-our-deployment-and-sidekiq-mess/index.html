<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Ensure our PNG og:image appears BEFORE jekyll-seo-tag so crawlers pick it -->
  <meta property="og:image" content="http://localhost:4000/assets/images/covers/deployment-sidekiq-fix.png">
  <meta name="twitter:image" content="http://localhost:4000/assets/images/covers/deployment-sidekiq-fix.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>What finally fixed our deployment and Sidekiq mess | Code It Forward</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="What finally fixed our deployment and Sidekiq mess" />
<meta name="author" content="Bob Roberts" />
<meta property="og:locale" content="en" />
<meta name="description" content="A week of production chaos taught me that Sidekiq failures aren’t always about Sidekiq. Sometimes it’s your database connection pool that’s starving everything else." />
<meta property="og:description" content="A week of production chaos taught me that Sidekiq failures aren’t always about Sidekiq. Sometimes it’s your database connection pool that’s starving everything else." />
<link rel="canonical" href="http://localhost:4000/rails/production/2025/09/12/what-finally-fixed-our-deployment-and-sidekiq-mess/" />
<meta property="og:url" content="http://localhost:4000/rails/production/2025/09/12/what-finally-fixed-our-deployment-and-sidekiq-mess/" />
<meta property="og:site_name" content="Code It Forward" />
<meta property="og:image" content="http://localhost:4000/assets/images/covers/deployment-sidekiq-fix.svg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-09-12T11:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/images/covers/deployment-sidekiq-fix.svg" />
<meta property="twitter:title" content="What finally fixed our deployment and Sidekiq mess" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@Bob Roberts" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Bob Roberts"},"dateModified":"2025-09-12T11:00:00-05:00","datePublished":"2025-09-12T11:00:00-05:00","description":"A week of production chaos taught me that Sidekiq failures aren’t always about Sidekiq. Sometimes it’s your database connection pool that’s starving everything else.","headline":"What finally fixed our deployment and Sidekiq mess","image":"http://localhost:4000/assets/images/covers/deployment-sidekiq-fix.svg","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/rails/production/2025/09/12/what-finally-fixed-our-deployment-and-sidekiq-mess/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/logo.svg"},"name":"Bob Roberts"},"url":"http://localhost:4000/rails/production/2025/09/12/what-finally-fixed-our-deployment-and-sidekiq-mess/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/main.css">
  <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">
  <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Code It Forward" /><!-- Preload fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Theme color for mobile browsers -->
  <meta name="theme-color" content="#0d1117">
  <meta name="msapplication-navbutton-color" content="#0d1117">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body><header class="site-header">
  <div class="container">
    <div class="header-content">
      <a class="site-title" href="/">
        Code It Forward
      </a>

      <!-- Mobile menu toggle -->
      <button class="nav-toggle" aria-label="Toggle navigation">
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
      </button>

      <nav class="site-nav">
        <a href="/" >
          Home
        </a>
        <a href="/posts/" >
          Blog
        </a>
        <a href="/archive/" >
          Archive
        </a>
        <a href="/search/" >
          Search
        </a>
        <a href="/about/" >
          About
        </a>
        <a href="/resume/" >
          Resume
        </a>
        <a href="/contact/" >
          Contact
        </a>
        <a href="/payitforward/" class="payforward-link">#payitforward</a>
      </nav>
    </div>
  </div>
</header>

<script>
// Mobile navigation toggle
(function() {
  const toggle = document.querySelector('.nav-toggle');
  const nav = document.querySelector('.site-nav');
  
  if (toggle && nav) {
    toggle.addEventListener('click', function() {
      nav.classList.toggle('active');
      toggle.classList.toggle('active');
    });

    // Close menu when clicking on a link
    nav.addEventListener('click', function(e) {
      if (e.target.tagName === 'A') {
        nav.classList.remove('active');
        toggle.classList.remove('active');
      }
    });

    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
      if (!toggle.contains(e.target) && !nav.contains(e.target)) {
        nav.classList.remove('active');
        toggle.classList.remove('active');
      }
    });
  }
})();
</script>
<main class="main-content" aria-label="Content">
    <div class="container">
      <div class="content">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">What finally fixed our deployment and Sidekiq mess</h1>

    <div class="post-meta">
      <time class="dt-published" datetime="2025-09-12T11:00:00-05:00" itemprop="datePublished">
        September 12, 2025
      </time><span itemprop="author" itemscope itemtype="http://schema.org/Person">
          <span class="p-author h-card" itemprop="name">Bob Roberts</span>
        </span><span class="reading-time"> • <span id="reading-time"></span></span>
    </div>

    <nav id="post-toc" class="post-toc" aria-label="Table of contents"></nav><div class="post-tags"><span class="tag">sidekiq</span><span class="tag">deployment</span><span class="tag">passenger</span><span class="tag">mysql</span><span class="tag">redis</span><span class="tag">activerecord</span><span class="tag">database-pool</span></div>
      <figure class="post-hero">
        <img src="/assets/images/covers/deployment-sidekiq-fix.svg" alt="What finally fixed our deployment and Sidekiq mess" style="object-position: center center;">
        
      </figure>
    
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Over the last week I hit a cluster of production problems that looked unrelated at first: intermittent deploys that “completed” but left the app unresponsive, email blasts that “finished” with zero sends, and a Sidekiq dashboard screaming 60–70% failure rates. This post is my straight‑from-the-console write‑up of what actually broke, how I tracked it down, and the simple changes that stabilized everything.</p>

<p>If you’re running Rails on Nginx + Passenger with MySQL, Redis, and Sidekiq (and some Delayed Job still hanging around), this will probably feel familiar.</p>

<h2 id="the-symptoms">The symptoms</h2>

<ul>
  <li>Deploy “succeeds,” site feels sluggish or unresponsive afterward.</li>
  <li>Sidekiq shows high failure rates, idle workers, and no throughput.</li>
  <li>Email blasts target thousands of customers but report zero sent.</li>
  <li>Logs full of noise in test and prod, making the real issues easy to miss.</li>
</ul>

<h2 id="the-real-root-cause">The real root cause</h2>

<p>It wasn’t a single bug. It was a perfect storm:</p>

<ul>
  <li>A Ruby upgrade changed memory/boot characteristics.</li>
  <li>I had both Sidekiq and Delayed Job running (historical reasons).</li>
  <li>Passenger was running multiple app processes.</li>
  <li>And the big one: the database pool was way too small.</li>
</ul>

<p>Sidekiq wasn’t “broken.” It was starved. Jobs were dying with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>could not obtain a database connection within 5.000 seconds
</code></pre></div></div>

<p>Once I stopped staring at Sidekiq’s failure counter and looked at actual error classes in Retry/Dead sets, the picture was obvious: ActiveRecord connection timeouts across the board.</p>

<h2 id="the-simple-calculation-that-matters">The simple calculation that matters</h2>

<p>This is the mental model I now use and documented in a deployment guide for future reference.</p>

<p>You need at least:</p>

<ul>
  <li>Passenger processes (each wants a DB connection)</li>
  <li>plus Sidekiq threads across all processes</li>
  <li>plus a little buffer (console, rake tasks, admin scripts, spikes)</li>
</ul>

<p>Example from my production box:</p>

<ul>
  <li>Passenger: 5 processes</li>
  <li>Sidekiq: 1 process × 3 threads (I dialed this down)</li>
  <li>Buffer: 5–10 (call it 7 for “stuff you forgot”)</li>
</ul>

<p>So minimum pool = 5 (Passenger) + 3 (Sidekiq) + 7 (buffer) = 15.
I set it to 25 because the server has plenty of RAM (32 GB) and I’d rather have headroom than timeouts.</p>

<p>Production <code class="language-plaintext highlighter-rouge">database.yml</code> ended up like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">production</span><span class="pi">:</span>
  <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
  <span class="na">pool</span><span class="pi">:</span> <span class="m">25</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">localhost</span>
  <span class="c1"># …rest omitted</span>
</code></pre></div></div>

<p>After bumping the pool, the connection timeouts disappeared immediately.</p>

<h2 id="the-sidekiq-side-of-the-house">The Sidekiq side of the house</h2>

<p>I also simplified my worker setup. I don’t need hero numbers here—predictability beats bragging rights. I now run:</p>

<ul>
  <li>Concurrency (threads): 3</li>
  <li>Processes: start one Sidekiq process (or two if I’m pushing a big blast)</li>
</ul>

<p>My <code class="language-plaintext highlighter-rouge">sidekiq.yml</code> reflects that:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">:concurrency: </span><span class="m">3</span>
<span class="s">:queues:</span>
  <span class="s">- [critical, 10]</span>
  <span class="s">- [email_blast, 6]</span>
  <span class="s">- [default, 5]</span>
</code></pre></div></div>

<p>If I want more fault tolerance or better CPU spread, I start a second Sidekiq process with the same concurrency. Two procs × 3 threads = 6 total DB connections, still fine under a 25‑connection pool.</p>

<h2 id="the-email-blast-gotcha-sidekiq-vs-delayed-job">The email blast gotcha (Sidekiq vs Delayed Job)</h2>

<p>My email blasts were “completing” with zero sends. The reason: the controller path had been switched to run synchronously during an earlier incident, while mailers still used <code class="language-plaintext highlighter-rouge">deliver_later</code> (which goes through ActiveJob → Delayed Job in this app). That left me in a half‑migrated state: some work in Sidekiq, some in DJ, both competing for the same small pool.</p>

<p>I re‑enabled async sending for blasts and let Sidekiq handle it. The worker is straight‑forward and logs failures cleanly:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SendEspecialsWorker</span>
  <span class="kp">include</span> <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Worker</span>
  <span class="n">sidekiq_options</span> <span class="ss">queue: :email_blast</span><span class="p">,</span> <span class="ss">retry: </span><span class="mi">3</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">account_id</span><span class="p">,</span> <span class="n">coupons</span><span class="p">,</span> <span class="n">email_blast_id</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="n">account</span> <span class="o">=</span> <span class="no">Account</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">account_id</span><span class="p">)</span>
    <span class="n">email_blast</span> <span class="o">=</span> <span class="n">email_blast_id</span> <span class="o">&amp;&amp;</span> <span class="no">EmailBlast</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">email_blast_id</span><span class="p">)</span>
    <span class="n">account</span><span class="p">.</span><span class="nf">send_especial</span><span class="p">(</span><span class="n">coupons</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="n">email_blast</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Key point: pick one background system per workflow. Mixing Sidekiq and Delayed Job on the same hot paths is a great way to create invisible contention.</p>

<h2 id="what-i-run-before-deploy-now">What I run before deploy now</h2>

<p>I pulled these steps into the deployment guide so I don’t “cowboy fix” at 2am again. The gist:</p>

<ul>
  <li>Clean up any straggler processes (nginx, passenger, delayed_job, ruby)</li>
  <li>Drop caches and restart in a clean order</li>
  <li>Start Sidekiq to the target concurrency</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl stop nginx
<span class="nb">sudo </span>pkill <span class="nt">-f</span> delayed_job<span class="p">;</span> <span class="nb">sudo </span>pkill <span class="nt">-f</span> passenger<span class="p">;</span> <span class="nb">sudo </span>pkill <span class="nt">-f</span> ruby
<span class="nb">sudo sync</span> <span class="o">&amp;&amp;</span> <span class="nb">echo </span>3 | <span class="nb">sudo tee</span> /proc/sys/vm/drop_caches
<span class="nb">sudo </span>systemctl start nginx
<span class="c"># start sidekiq with -c 3 and proper logs/PIDs</span>
</code></pre></div></div>

<p>Then I watch the first few minutes like a hawk:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">passenger-status</code> for process health and queue length</li>
  <li>Sidekiq stats for processed/failed trends and queue sizes</li>
  <li>Memory and swap to catch early pressure</li>
</ul>

<h2 id="quick-checks-that-saved-me-time">Quick checks that saved me time</h2>

<ul>
  <li>Confirm Sidekiq’s “Failed” vs Retry/Dead sets. Dashboard counters are cumulative. The real signal is “do new jobs fail?”</li>
  <li>Use <code class="language-plaintext highlighter-rouge">Sidekiq::Stats.new</code> and print before/after numbers around a test job. If processed goes up without failed, you’re good.</li>
  <li>Don’t trust logger levels alone in tests if you’re using <code class="language-plaintext highlighter-rouge">puts</code>. <code class="language-plaintext highlighter-rouge">puts</code> goes to STDOUT regardless; either switch to <code class="language-plaintext highlighter-rouge">Rails.logger</code> or redirect STDOUT in test.</li>
</ul>

<h2 id="what-id-do-differently-next-time">What I’d do differently next time</h2>

<ul>
  <li>Size the DB pool first. It’s the cheapest lever with the highest upside.</li>
  <li>Avoid half‑migrations. If a workflow starts on Sidekiq, finish the job and remove the Delayed Job path (or vice versa).</li>
  <li>Keep Sidekiq boring: low concurrency, more processes only when needed, queue weights tuned to business priorities.</li>
  <li>Document the decision math in the deployment guide, so future me doesn’t have to reconstruct it under pressure.</li>
</ul>

<h2 id="tldr">TL;DR</h2>

<ul>
  <li>The chronic failures weren’t Sidekiq being flaky—they were ActiveRecord connection timeouts.</li>
  <li>Passenger procs + Sidekiq threads + a buffer must fit under your DB <code class="language-plaintext highlighter-rouge">pool</code>.</li>
  <li>On a 32 GB host, a <code class="language-plaintext highlighter-rouge">pool: 25</code> is a rounding error in memory and buys you stability.</li>
  <li>Run email blasts async in Sidekiq; don’t split them across Sidekiq and Delayed Job.</li>
  <li>Keep Sidekiq to 3 threads per process unless you’ve proven you need more.</li>
</ul>

<p>If you want the full step‑by‑step let me know. I put everything into a document including cleanup commands, monitoring, and the connection math. It’s the checklist I wish I’d had before the week started.</p>

  </div>

  
    <section class="related-posts">
      <h3>Related posts</h3>
      <div class="posts-grid">
        
        
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
          
            
            
            
          
        
      </div>
    </section>
  


  <footer class="post-footer">
    <div class="post-share">
      <span>Share:</span>
      
      <a class="share-btn" href="https://www.linkedin.com/sharing/share-offsite/?url=http%3A%2F%2Flocalhost%3A4000%2Frails%2Fproduction%2F2025%2F09%2F12%2Fwhat-finally-fixed-our-deployment-and-sidekiq-mess%2F" target="_blank" rel="noopener">LinkedIn</a>
      <a class="share-btn" href="mailto:?subject=What+finally+fixed+our+deployment+and+Sidekiq+mess+%E2%80%94+%23payitforward&body=http%3A%2F%2Flocalhost%3A4000%2Frails%2Fproduction%2F2025%2F09%2F12%2Fwhat-finally-fixed-our-deployment-and-sidekiq-mess%2F" target="_blank" rel="noopener">Email</a>
      <button class="share-btn" type="button" id="copy-link-btn" data-url="http://localhost:4000/rails/production/2025/09/12/what-finally-fixed-our-deployment-and-sidekiq-mess/">Copy link</button>
    </div>

    <div class="pay-forward-callout">
      <strong>Pay it forward.</strong> If this helped you, consider sharing it with a colleague, mentoring someone, or contributing a tip to the <a href="/payitforward/">#payitforward</a> page.
    </div><div class="post-navigation"><div class="nav-previous">
          <a href="/rails/community/career/2025/09/12/the-rails-generation-gap-why-it-matters/" class="btn btn-secondary">
            ← The Rails Generation Gap: W...
          </a>
        </div></div>
  </footer>

  <a class="u-url" href="/rails/production/2025/09/12/what-finally-fixed-our-deployment-and-sidekiq-mess/" hidden></a>
</article>

  <script src="/assets/js/post.js" defer></script>

      </div>
    </div>
  </main><footer class="site-footer">
  <div class="container">
    <div class="footer-content">
      <div class="footer-section">
        <h4>Code It Forward</h4>
        <p>Practical Rails · React · GraphQL · TypeScript — pay it forward.</p>

        <div class="social-links"><a href="https://github.com/brobertsaz" title="GitHub">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
              </svg>
            </a><a href="mailto:brobertsaz@users.noreply.github.com" title="Email">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
              </svg>
            </a></div>
      </div>

      <div class="footer-section">
        <h4>Quick Links</h4>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/posts/">Blog</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="/resume/">Resume</a></li>
          <li><a href="/contact/">Contact</a></li>
        </ul>
      </div>

      <div class="footer-section">
        <h4>Recent Posts</h4>
        <ul><li>
              <a href="/rails/production/2025/09/12/what-finally-fixed-our-deployment-and-sidekiq-mess/">
                What finally fixed our depl...
              </a>
            </li><li>
              <a href="/rails/community/career/2025/09/12/the-rails-generation-gap-why-it-matters/">
                The Rails Generation Gap: W...
              </a>
            </li><li>
              <a href="/general/meta/2025/09/08/welcome-to-my-blog/">
                Dusting Off the Blog (Again)
              </a>
            </li></ul>
      </div>
    </div>

    <div class="footer-bottom">
      <p>&copy; 2025 Code It Forward. All rights reserved.</p>
    </div>
  </div>
</footer>
</body>

</html>
